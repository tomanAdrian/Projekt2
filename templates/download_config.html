<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <title>Stiahnutie konfigur치ci칤 zo sie콘ov칳ch zariaden칤</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <header>
        <h1>Stiahnutie konfigur치ci칤 zo sie콘ov칳ch zariaden칤</h1>
        <p>Katedra informa캜n칳ch siet칤, FRI UNIZA</p>
        <nav class="site-navigation">
            <ul class="menu">
                <li><a href="{{ url_for('index') }}">Porovn치vanie konfigur치ci칤</a></li>
                <li><a href="{{ url_for('batch') }}">Hromadn칠 porovn치vanie</a></li>
                <li><a href="{{ url_for('download') }}">Stiahnutie konfigur치ci칤</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <div class="column">
            <h2>Zadajte zariadenia</h2>
            <p>Ka쬯칠 zariadenie na nov칳 riadok (<code>ip_adresa:port</code>):</p>
            <textarea id="device_addresses" rows="5" placeholder="192.168.1.1:23&#10;192.168.1.2:23"></textarea>

            <label for="username"><strong>Prihlasovacie meno:</strong></label>
            <input type="text" id="username" placeholder="Zadajte meno">

            <label for="password"><strong>Prihlasovacie heslo:</strong></label>
            <div class="password-container">
                <input type="password" id="password" placeholder="Zadajte heslo">
                <button type="button" onclick="togglePassword()">Zobrazi콘</button>
            </div>

            <button onclick="downloadConfigs()">Z칤ska콘 konfigur치ciu</button>
            <div id="downloadLinks" style="margin-top:1rem;"></div>
        </div>

        <div class="column" id="configDisplay">
            <h2>V칳stup konfigur치cie</h2>
            <div class="config-output">
                <pre id="configOutput">Konfigur치cia sa zobraz칤 tu...</pre>
            </div>
            <!-- Tla캜idlo na stiahnutie sa zobraz칤 dynamicky -->
            <button id="downloadBtn" style="display:none;" onclick="downloadFile()">Stiahnutie konfigur치cie</button>
        </div>
    </div>

    <footer>
        <strong>&copy; 2024 FRI UNIZA, Katedra informa캜n칳ch siet칤</strong>
    </footer>

    <script>
        function togglePassword() {
            const input = document.getElementById("password");
            input.type = input.type === "password" ? "text" : "password";
        }

        let lastFileUrl, lastHostname;
        function downloadConfigs() {
            const addresses = document.getElementById("device_addresses").value;
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            console.log("游닋 downloadConfigs() called with:");
            console.log("  addresses:", addresses.split("\n"));
            console.log("  username:", username);
            // (!) nechceme logova콘 heslo v produkcii, ale teraz pri debugu
            console.log("  password:", password);
            if (!addresses.trim()) { alert("Zadajte aspo켿 jedno zariadenie."); return; }
            console.log("游댕 POSTing to", "{{ url_for('download_configs') }}");
            fetch("{{ url_for('download_configs') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ addresses: addresses.split("\n"), username, password })
            })
            .then(r=>r.json())
            .then(data=>{
                if (data.error) {
                    alert(data.error);
                    return
                } 
                 // 1) zobraz칤me cel칳 v칳pis
                document.getElementById("configOutput").textContent = data.configs;

                // 2) priprav칤me tla캜idlo na stiahnutie
                //    ak m치me viac URL (viac s칰borov), m칪쬰me zobrazi콘 linky,
                //    tu ale uk치쬰me iba prv칰:
                if (data.file_urls && data.file_urls.length > 0) {
                lastFileUrl = data.file_urls[0];               // prv칳 .txt
                // hostname vydlabeme z cesty, napr. "configs/R1.txt" -> "R1"
                lastHostname = lastFileUrl.split("/").pop().replace(/\.[^.]+$/, "");
                document.getElementById("downloadBtn").style.display = "block";
                } else {
                // ak bundle_url
                lastFileUrl = data.bundle_url;
                lastHostname = "configs_bundle";
                document.getElementById("downloadBtn").style.display = "block";
                }
            })
            .catch(e=>console.error(e));
        }

        function downloadFile() {
            // stiahne s칰bor s n치zvom <hostname>.txt
            const a = document.createElement("a");
            a.href = lastFileUrl;
            a.download = lastHostname + ".txt";
            a.click();
        }
    </script>
</body>
</html>
