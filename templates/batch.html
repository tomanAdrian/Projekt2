        <!DOCTYPE html>
        <html lang="sk">
        <head>
            <meta charset="UTF-8">
            <title>Hromadné porovnávanie konfigurácií zo sieťových zariadení</title>
            <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
        </head>
        <body>
            <header>
                <h1>Hromadné porovnávanie konfigurácií zo sieťových zariadení</h1>
                <p>Katedra informačných sietí, FRI UNIZA</p>
                <nav class="site-navigation">
                        <ul class="menu">
                            <li><a href="{{ url_for('index') }}">Porovnávanie konfigurácií</a></li>
                            <li><a href="{{ url_for('batch') }}">Hromadné porovnávanie</a></li>
                            <li><a href="{{ url_for('download') }}">Stiahnutie konfigurácií</a></li>
                        </ul>
                </nav>
            </header>
            

            <div class="container" style="padding-bottom: 0;">
                <!-- Ľavá sekcia -->
                <div class="column">
                    <h2>Referenčná konfigurácia (správna)</h2>
                    <p style="margin: 0;">Vyberte možnosť:</p>
                    <div class="radio-options">
                        <label>
                            <input type="radio" id="ref_option_download_device" name="ref_input_option" checked value="download_device" onchange="toggleLeftSection()">
                            Stiahnuť konfiguráciu zo zariadenia/zariadení (ip_adresa:port)
                        </label>
                        <label>
                            <input type="radio" id="ref_option_download_device_auth" name="ref_input_option" value="download_device_auth" onchange="toggleLeftSection()">
                            Stiahnuť konfiguráciu zo zariadenia/zariadení (ip_adresa:port;meno;heslo)
                        </label>
                        <label>
                            <input type="radio" id="ref_option_device_file" name="ref_input_option" value="ref_device_file" onchange="toggleLeftSection()">
                            Nahrať konfigurácie zo súborov (poradie = poradie zariadení vľavo)
                        </label>
                    </div> 
            
                    <!-- Dynamická časť pre ľavú sekciu -->
                    <div id="ref_device_file_upload" style="display: none;">
                        <label for="ref_files_input" style="font-weight: bold;">Nahrať súbory:</label>
                        <input type="file" id="ref_files_input" multiple style="display: none;" />
                        <button type="button" id="add_ref_file_button">Pridať súbory</button>
                        <p style="font-size: 12px; color: gray;">Poradie súborov = poradie zariadení zadané vľavo</p>

                        <ul id="ref_file_list" class="sortable-file-list"></ul>
                    </div>
                    <div id="ref_text_input">
                        <label for="ref_username"style="font-weight: bold;">Prihlasovacie meno:</label>
                        <input type="text" id="ref_username" placeholder="Zadajte meno">
                        <label for="ref_password"style="font-weight: bold;">Prihlasovacie heslo:</label>
                        <div class="password-container">
                            <input type="password" id="ref_password" placeholder="Zadajte heslo">
                            <button type="button" onclick="togglePasswordVisibility('ref_password', this)">Zobraziť</button>
                        </div>
                        <label for="ref_addresses"style="font-weight: bold;">Zariadenia (ip_adresa:port):</label>
                        <textarea id="ref_addresses" rows="10" placeholder="Každá adresa na nový riadok..."></textarea>
                    </div>
                    <div id="ref_text_input_auth" style="display: none;">
                        <label for="ref_addresses_auth"style="font-weight: bold;">Zariadenia (ip_adresa:port;meno;heslo):</label>
                        <textarea id="ref_addresses_auth" rows="10" placeholder="Každá adresa na nový riadok..."></textarea>
                    </div>
                </div>
            
                <!-- Pravá sekcia -->
                <div class="column">
                    <h2>Konfigurácia na porovnanie</h2>
                    <p style="margin: 0;">Vyberte možnosť:</p>
                    <div class="radio-options">
                        <label>
                            <input type="radio" id="comp_option_download_device" name="comp_input_option" value="download_device" checked onchange="toggleRightSection()">
                            Stiahnuť konfiguráciu zo zariadenia/zariadení (ip_adresa:port)
                        </label>
                        <label>
                            <input type="radio" id="comp_option_download_device_auth" name="comp_input_option" value="download_device_auth" onchange="toggleRightSection()">
                            Stiahnuť konfiguráciu zo zariadenia/zariadení (ip_adresa:port;meno;heslo)
                        </label>
                        <label>
                            <input type="radio" id="comp_option_device_file" name="comp_input_option" value="comp_device_file" onchange="toggleRightSection()">
                            Nahrať konfigurácie zo súborov (poradie = poradie zariadení vľavo)
                        </label>
                    </div>
            
                    <!-- Dynamická časť pre pravú sekciu -->
                    <div id="comp_device_file_upload" style="display: none;">
                        <label for="comp_files_input" style="font-weight: bold;">Nahrať súbory:</label>
                        <input type="file" id="comp_files_input" multiple style="display: none;" />
                        <button type="button" id="add_comp_file_button">Pridať súbory</button>
                        <p style="font-size: 12px; color: gray;">Poradie súborov = poradie zariadení zadané vľavo</p>
                        <ul id="comp_file_list" class="sortable-file-list"></ul>
                    </div>
                    <div id="comp_text_input">
                        <label for="comp_username"style="font-weight: bold;">Prihlasovacie meno:</label>
                        <input type="text" id="comp_username" placeholder="Zadajte meno">
                        <label for="comp_password"style="font-weight: bold;">Prihlasovacie heslo:</label>
                        <div class="password-container">
                            <input type="password" id="comp_password" placeholder="Zadajte heslo">
                            <button type="button" onclick="togglePasswordVisibility('comp_password', this)">Zobraziť</button>
                        </div>
                        <label for="comp_addresses"style="font-weight: bold;">Zariadenia (ip_adresa:port):</label>
                        <textarea id="comp_addresses" rows="10" placeholder="Každá adresa na nový riadok..."></textarea>
                    </div>
                    <div id="comp_text_input_auth" style="display: none;">
                        <label for="comp_addresses_auth"style="font-weight: bold;">Zariadenia (ip_adresa:port;meno;heslo):</label>
                        <textarea id="comp_addresses_auth" rows="10" placeholder="Každá adresa na nový riadok..."></textarea>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <div style="display: inline-flex; align-items: center; gap: 20px;">
                    <button id="compareButton" onclick="compareConfigs()">Porovnať konfigurácie</button>
                    <div id="comparingMessage" style="display: none; font-weight: bold; color: #0056b3;">Porovnávam...</div>

            
                    <div class="settings-wrapper">
                        <div class="settings-icon" onclick="toggleSettingsMenu()">⚙️</div>
                        <div id="settings-menu" class="settings-menu">
                            <h3>Nastavenia porovnávania</h3>
                    
                            <label>
                                <input type="radio" name="compare_mode" value="school_ai_line_by_line" checked>
                                Školské AI + riadkové porovnávanie
                            </label><br>
                    
                            <label>
                                <input type="radio" name="compare_mode" value="school_ai">
                                Použiť AI – školská
                            </label><br>
                    
                            <label>
                                <input type="radio" name="compare_mode" value="chatgpt_ai">
                                Použiť AI – ChatGPT
                            </label>
                    
                            <div id="api-key-input" style="display: none; margin-top: 10px;">
                                <label for="api_key">API kľúč:</label>
                                <input type="text" id="api_key" placeholder="Vložte svoj API kľúč" style="width: 100%;">
                            </div><br>
                    
                            <label>
                                <input type="radio" name="compare_mode" value="line_by_line">
                                Len riadkové porovnávanie
                            </label><br>
                    
                            <div id="model-selector-wrapper" style="display: block;">
                                <label for="model-selector">Výber modelu:</label>
                                <select id="model-selector">
                                    <!-- dynamicky plnené podľa výberu módu -->
                                </select>
                            </div>
                        </div>
                    </div>          
                </div>
            </div>
            <footer>
                <strong> &copy; 2024 FRI UNIZA, Katedra informačných sietí,</strong> Projekt: Automatické sťahovanie a vyhodnocovanie konfigurácie.        
            </footer>

            <script>
                let refFileList = [];
                let compFileList = [];

                function setupFileUpload(inputId, buttonId, listId, fileList, renderFunction) {
                    const input = document.getElementById(inputId);
                    const button = document.getElementById(buttonId);
                    const list = document.getElementById(listId);

                    button.addEventListener('click', () => input.click());

                    input.addEventListener('change', () => {
                        const newFiles = Array.from(input.files);
                        newFiles.forEach(f => {
                            if (!fileList.some(existing => existing.name === f.name && existing.size === f.size)) {
                                fileList.push(f);
                            }
                        });
                        input.value = '';
                        renderFunction();
                    });

                    list.addEventListener('dragstart', (e) => {
                        if (e.target.tagName === 'LI') {
                            e.target.classList.add('dragging');
                            e.dataTransfer.setData('text/plain', e.target.dataset.index);
                        }
                    });

                    list.addEventListener('dragend', (e) => {
                        e.target.classList.remove('dragging');
                    });

                    list.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        const afterElement = getDragAfterElement(list, e.clientY);
                        const dragging = document.querySelector('.dragging');
                        if (afterElement == null) {
                            list.appendChild(dragging);
                        } else {
                            list.insertBefore(dragging, afterElement);
                        }
                    });

                    function getDragAfterElement(container, y) {
                        const elements = [...container.querySelectorAll('li:not(.dragging)')];
                        return elements.reduce((closest, child) => {
                            const box = child.getBoundingClientRect();
                            const offset = y - box.top - box.height / 2;
                            if (offset < 0 && offset > closest.offset) {
                                return { offset, element: child };
                            } else {
                                return closest;
                            }
                        }, { offset: Number.NEGATIVE_INFINITY }).element;
                    }
                }
                
                function renderRefList() {
                    const list = document.getElementById('ref_file_list');
                    list.innerHTML = '';
                    refFileList.forEach((file, index) => {
                        const li = document.createElement('li');
                        li.draggable = true;
                        li.dataset.index = index;
                        li.innerHTML = `
                            <span class="filename">${file.name}</span>
                            <button class="remove-btn" onclick="removeRefFile(${index})">&times;</button>
                        `;
                        list.appendChild(li);
                    });
                }

                function getSortedRefFiles() {
                // vyberiem všetky li v tom poradí, ako sú v DOM
                const items = Array.from(document.querySelectorAll('#ref_file_list li'));
                // podľa názvu nájdem pôvodný File objekt
                return items.map(li => {
                    const name = li.querySelector('.filename').textContent;
                    return refFileList.find(f => f.name === name && f.size === f.size);
                }).filter(f => f); // odstráni prípadné undefined
                }

                function getSortedCompFiles() {
                const items = Array.from(document.querySelectorAll('#comp_file_list li'));
                return items.map(li => {
                    const name = li.querySelector('.filename').textContent;
                    return compFileList.find(f => f.name === name && f.size === f.size);
                }).filter(f => f);
                }

                function renderCompList() {
                    const list = document.getElementById('comp_file_list');
                    list.innerHTML = '';
                    compFileList.forEach((file, index) => {
                        const li = document.createElement('li');
                        li.draggable = true;
                        li.dataset.index = index;
                        li.innerHTML = `
                            <span class="filename">${file.name}</span>
                            <button class="remove-btn" onclick="removeCompFile(${index})">&times;</button>
                        `;
                        list.appendChild(li);
                    });
                }

                function removeRefFile(index) {
                    refFileList.splice(index, 1);
                    renderRefList();
                }

                function removeCompFile(index) {
                    compFileList.splice(index, 1);
                    renderCompList();
                }

                function getSortedRefFiles() {
                    const filenames = [...document.querySelectorAll('#ref_file_list .filename')].map(el => el.textContent);
                    return refFileList.sort((a, b) => filenames.indexOf(a.name) - filenames.indexOf(b.name));
                }

                function getSortedCompFiles() {
                    const filenames = [...document.querySelectorAll('#comp_file_list .filename')].map(el => el.textContent);
                    return compFileList.sort((a, b) => filenames.indexOf(a.name) - filenames.indexOf(b.name));
                }


                function renderList() {
                    list.innerHTML = '';
                    fileList.forEach((file, index) => {
                        const li = document.createElement('li');
                        li.draggable = true;
                        li.dataset.index = index;
                        li.innerHTML = `
                            <span class="filename">${file.name}</span>
                            <button class="remove-btn" onclick="removeFile(${index})">&times;</button>
                        `;
                        list.appendChild(li);
                    });
                }

                function removeFile(index) {
                    fileList.splice(index, 1);
                    renderList();
                }

                

                // Volateľné pre backend spracovanie:
                function getSortedFiles() {
                    const filenames = [...list.querySelectorAll('li')].map(li => li.querySelector('.filename').textContent);
                    return fileList.sort((a, b) => filenames.indexOf(a.name) - filenames.indexOf(b.name));
                }
                
                const refInput = document.getElementById('ref_files');
                const refList = document.getElementById('ref_file_list');
                let refFileOrder = [];

                // Drag & drop logic
                let draggedIndex = null;    

                function toggleLeftSection() {
                    const selectedOption = document.querySelector('input[name="ref_input_option"]:checked').value;
                    document.getElementById('ref_text_input').style.display = selectedOption === 'download_device' ? 'block' : 'none';
                    document.getElementById('ref_text_input_auth').style.display = selectedOption === 'download_device_auth' ? 'block' : 'none';
                    document.getElementById('ref_device_file_upload').style.display = selectedOption === 'ref_device_file' ? 'block' : 'none';
                }

                function toggleRightSection() {
                    const selectedOption = document.querySelector('input[name="comp_input_option"]:checked').value;
                    document.getElementById('comp_text_input').style.display = selectedOption === 'download_device' ? 'block' : 'none';
                    document.getElementById('comp_text_input_auth').style.display = selectedOption === 'download_device_auth' ? 'block' : 'none';
                    document.getElementById('comp_device_file_upload').style.display = selectedOption === 'comp_device_file' ? 'block' : 'none';
                }

                function togglePasswordVisibility(inputId, button) {
                    const input = document.getElementById(inputId);
                    if (input.type === "password") {
                        input.type = "text";
                        button.textContent = "Skryť";
                    } else {
                        input.type = "password";
                        button.textContent = "Zobraziť";
                    }
                }

                function isValidIpPort(str) {
                    const regex = /^(\d{1,3}\.){3}\d{1,3}:\d{1,5}$/;
                    return regex.test(str);
                }

                function isValidIpUser(str) {
                    const parts = str.split(';');
                    if (parts.length < 2 || parts.length > 3) return false;
                    return isValidIpPort(parts[0]) && parts[1].trim() !== "";
                }

                function getSortedFiles() {
                    const filenames = [...document.querySelectorAll('#ref_file_list .filename')]
                        .map(el => el.textContent);
                    return fileList.sort((a, b) => filenames.indexOf(a.name) - filenames.indexOf(b.name));
                }

                function compareConfigs() {
                    const refOption  = document.querySelector('input[name="ref_input_option"]:checked').value;
                    const compOption = document.querySelector('input[name="comp_input_option"]:checked').value;

                    const compareMode = document.querySelector('input[name="compare_mode"]:checked')?.value || "school_ai_line_by_line";
                    const model = document.getElementById("model-selector")?.value || null;
                    const apiKey = document.getElementById("api_key")?.value || null;

                    // === 1. OBOJE SÚ SÚBORY ===
                    if (refOption === "ref_device_file" && compOption === "comp_device_file") {
                        const refFiles  = getSortedRefFiles();
                        const compFiles = getSortedCompFiles();

                        if (!refFiles.length || !compFiles.length) {
                            alert("Musíte nahrať súbory pre obidve strany.");
                            return;
                        }

                        if (refFiles.length !== compFiles.length) {
                            alert("Počet súborov v referenčnej a porovnávanej konfigurácii sa musí zhodovať.");
                            return;
                        }

                        const formData = new FormData();
                        refFiles.forEach(file => formData.append("ref_files", file));
                        compFiles.forEach(file => formData.append("comp_files", file));
                        formData.append("compare_mode", compareMode);
                        if (model) formData.append("model", model);
                        if (apiKey) formData.append("api_key", apiKey);

                        document.getElementById("compareButton").style.display = "none";
                        document.getElementById("comparingMessage").style.display = "block";

                        fetch("/compare_files", {
                            method: "POST",
                            body: formData
                        })
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById("compareButton").style.display = "block";
                            document.getElementById("comparingMessage").style.display = "none";

                            if (data.error) {
                                alert("❌ Chyba: " + data.error);
                                return;
                            }

                            document.getElementById("refResult").innerHTML = data.correctoutput;
                            document.getElementById("compResult").innerHTML = data.compareoutput;
                            document.getElementById("similarity-percentage").innerText = data.similarity + "%";
                            window.latestReportFilename = data.report;

                            document.getElementById("resultsContainer").style.display = "block";
                        })
                        .catch(err => {
                            alert("❌ Nastala chyba počas odosielania: " + err.message);
                            document.getElementById("compareButton").style.display = "block";
                            document.getElementById("comparingMessage").style.display = "none";
                        });

                        return;
                    } 
                    // --- 2) Súbor vs. zariadenie ---
                    if (refOption === "ref_device_file" &&
                        (compOption === "download_device" || compOption === "download_device_auth")) {

                        const refFiles = getSortedRefFiles();
                        if (!refFiles.length) {
                        return alert("Nahrajte aspoň jeden referenčný súbor.");
                        }

                        const fd = new FormData();
                        refFiles.forEach(f => fd.append("ref_files", f));
                        fd.append("mode", "file_vs_device");

                        if (compOption === "download_device") {
                        const user  = document.getElementById("comp_username").value.trim();
                        const pass  = document.getElementById("comp_password").value.trim();
                        const addrs = document.getElementById("comp_addresses").value
                                        .split("\n").map(l => l.trim()).filter(l => l);
                        if (!user || !addrs.length) {
                            return alert("Vyplňte meno a adresy pre porovnanie.");
                        }
                        fd.append("comp_mode", "download_device");
                        fd.append("comp_user", user);
                        fd.append("comp_pass", pass);
                        addrs.forEach(a => fd.append("comp_addresses", a));
                        } else {
                        const lines = document.getElementById("comp_addresses_auth").value
                                        .split("\n").map(l => l.trim()).filter(l => l);
                        if (!lines.length) {
                            return alert("Vyplňte ip:port;meno;heslo pre porovnanie.");
                        }
                        fd.append("comp_mode", "download_device_auth");
                        lines.forEach(l => fd.append("comp_addresses_auth", l));
                        }

                        fd.append("compare_mode", compareMode);
                        if (model)  fd.append("model", model);
                        if (apiKey) fd.append("api_key", apiKey);

                        // UI feedback
                        document.getElementById("compareButton").style.display     = "none";
                        document.getElementById("comparingMessage").style.display = "block";

                        // jediný fetch s .then(...)
                        fetch("/compare_mixed", { method: "POST", body: fd })
                        .then(res => {
                            if (!res.ok) throw new Error(`HTTP ${res.status}`);
                            return res.json();
                        })
                        .then(data => {
                            // obnovíme tlačidlo
                            document.getElementById("compareButton").style.display     = "inline-block";
                            document.getElementById("comparingMessage").style.display = "none";

                            if (data.error) {
                            return alert("Chyba: " + data.error);
                            }

                            document.getElementById("refResult").innerHTML             = data.correctoutput;
                            document.getElementById("compResult").innerHTML            = data.compareoutput;
                            document.getElementById("similarity-percentage").innerText = data.similarity + "%";
                            window.latestReportFilename                               = data.report;
                            document.getElementById("resultsContainer").style.display  = "block";
                        })
                        .catch(err => {
                            document.getElementById("compareButton").style.display     = "inline-block";
                            document.getElementById("comparingMessage").style.display = "none";
                            alert("Chyba počas komunikácie: " + err.message);
                        });

                        return;
                    }


                    // --- 3) Zariadenie vs. súbor ---
                    if ((refOption === "download_device" || refOption === "download_device_auth") &&
                        compOption === "comp_device_file") {

                        const compFiles = getSortedCompFiles();
                        if (!compFiles.length) {
                        return alert("Nahrajte aspoň jeden porovnávaný súbor.");
                        }

                        const fd = new FormData();
                        compFiles.forEach(f => fd.append("comp_files", f));
                        fd.append("mode", "device_vs_file");

                        if (refOption === "download_device") {
                        const user  = document.getElementById("ref_username").value.trim();
                        const pass  = document.getElementById("ref_password").value.trim();
                        const addrs = document.getElementById("ref_addresses").value
                                        .split("\n").map(l => l.trim()).filter(l => l);
                        if (!user || !addrs.length) {
                            return alert("Vyplňte meno a adresy pre referenciu.");
                        }
                        fd.append("ref_mode", "download_device");
                        fd.append("ref_user", user);
                        fd.append("ref_pass", pass);
                        addrs.forEach(a => fd.append("ref_addresses", a));
                        } else {
                        const lines = document.getElementById("ref_addresses_auth").value
                                        .split("\n").map(l => l.trim()).filter(l => l);
                        if (!lines.length) {
                            return alert("Vyplňte ip:port;meno;heslo pre referenciu.");
                        }
                        fd.append("ref_mode", "download_device_auth");
                        lines.forEach(l => fd.append("ref_addresses_auth", l));
                        }

                        fd.append("compare_mode", compareMode);
                        if (model)  fd.append("model", model);
                        if (apiKey) fd.append("api_key", apiKey);

                        document.getElementById("compareButton").style.display     = "none";
                        document.getElementById("comparingMessage").style.display = "block";

                        fetch("/compare_mixed", { method: "POST", body: fd })
                        .then(res => {
                            if (!res.ok) throw new Error(`HTTP ${res.status}`);
                            return res.json();
                        })
                        .then(data => {
                            document.getElementById("compareButton").style.display     = "inline-block";
                            document.getElementById("comparingMessage").style.display = "none";

                            if (data.error) {
                            return alert("Chyba: " + data.error);
                            }

                            document.getElementById("refResult").innerHTML             = data.correctoutput;
                            document.getElementById("compResult").innerHTML            = data.compareoutput;
                            document.getElementById("similarity-percentage").innerText = data.similarity + "%";
                            window.latestReportFilename                               = data.report;
                            document.getElementById("resultsContainer").style.display  = "block";
                        })
                        .catch(err => {
                            document.getElementById("compareButton").style.display     = "inline-block";
                            document.getElementById("comparingMessage").style.display = "none";
                            alert("Chyba počas komunikácie: " + err.message);
                        });

                        return;
                    }


                    // === 4. OSTATNÉ MOŽNOSTI (download zo zariadení)
                    const requestData = {
                        compare_mode: compareMode,
                        model: model,
                        api_key: apiKey
                    };

                    // === REFERENČNÁ KONFIGURÁCIA ===
                    if (refOption === 'download_device') {
                        const username = document.getElementById('ref_username').value.trim();
                        const addresses = document.getElementById('ref_addresses').value.trim();

                        if (!username || !addresses) {
                            alert("Vyplňte meno a zariadenia pre referenčnú konfiguráciu.");
                            return;
                        }

                        const addrLines = addresses.split('\n').filter(line => line.trim() !== "");
                        if (!addrLines.every(isValidIpPort)) {
                            alert("Chybný formát v referenčných zariadeniach. Očakávaný formát: ip_adresa:port");
                            return;
                        }

                        requestData.correct_router = {
                            username,
                            password: document.getElementById('ref_password').value.trim(),
                            addresses: addrLines
                        };
                    } else if (refOption === 'download_device_auth') {
                        const authLines = document.getElementById('ref_addresses_auth').value.trim().split('\n').filter(l => l.trim() !== "");

                        if (authLines.length === 0) {
                            alert("Zadajte zariadenia s prihlasovacími údajmi pre referenčnú konfiguráciu.");
                            return;
                        }

                        if (!authLines.every(isValidIpUser)) {
                            alert("Chybný formát v referenčných zariadeniach. Očakávaný formát: ip_adresa:port;meno alebo ip_adresa:port;meno;heslo");
                            return;
                        }

                        requestData.correct_router = {
                            addresses_auth: authLines
                        };
                    }

                    // === POROVNÁVANÁ KONFIGURÁCIA ===
                    if (compOption === 'download_device') {
                        const username = document.getElementById('comp_username').value.trim();
                        const addresses = document.getElementById('comp_addresses').value.trim();

                        if (!username || !addresses) {
                            alert("Vyplňte meno a zariadenia pre porovnávanú konfiguráciu.");
                            return;
                        }

                        const addrLines = addresses.split('\n').filter(line => line.trim() !== "");
                        if (!addrLines.every(isValidIpPort)) {
                            alert("Chybný formát v porovnávaných zariadeniach. Očakávaný formát: ip_adresa:port");
                            return;
                        }

                        requestData.routers_with_errors = addrLines.map((address) => ({
                            username,
                            password: document.getElementById('comp_password').value.trim(),
                            address
                        }));
                    } else if (compOption === 'download_device_auth') {
                        const authLines = document.getElementById('comp_addresses_auth').value.trim().split('\n').filter(l => l.trim() !== "");

                        if (authLines.length === 0) {
                            alert("Zadajte zariadenia s prihlasovacími údajmi pre porovnávanú konfiguráciu.");
                            return;
                        }

                        if (!authLines.every(isValidIpUser)) {
                            alert("Chybný formát v porovnávaných zariadeniach. Očakávaný formát: ip_adresa:port;meno alebo ip_adresa:port;meno;heslo");
                            return;
                        }

                        requestData.routers_with_errors = authLines.map(line => {
                            const [address, username, password = ""] = line.split(';');
                            return { address, username, password };
                        });
                    }

                    // === Odošli štandardný request na /compare ===
                    sendData(requestData);
                }

                // Funkcia na odoslanie údajov na server
                function sendData(data) {
                    document.getElementById("compareButton").style.display = "none";
                    document.getElementById("comparingMessage").style.display = "block";

                    fetch('/compare', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    })
                    .then((response) => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(err.error || "Chyba počas spracovania.");
                            });
                        }
                        return response.json();
                    })
                    .then((result) => {
                        const refResult = document.getElementById("refResult");
                        const compResult = document.getElementById("compResult");
                        const similarityText = document.getElementById("similarity-percentage");
                        const resultsContainer = document.getElementById("resultsContainer");

                        refResult.innerHTML = result.correctoutput;
                        compResult.innerHTML = result.compareoutput;
                        similarityText.innerText = result.similarity ? result.similarity + "%" : "N/A";
                        window.latestReportFilename = result.report;

                        resultsContainer.style.display = "block";

                        document.getElementById("compareButton").style.display = "block";
                        document.getElementById("comparingMessage").style.display = "none";
                    })
                    .catch((error) => {
                        alert("❌ Nastala chyba: " + error.message);
                        console.error("Chyba:", error);
                        document.getElementById("compareButton").style.display = "block";
                        document.getElementById("comparingMessage").style.display = "none";
                    });
                }

                
                function formatConfiguration(config, differences, isReference) {
                    const lines = config.split("\n");
                    return lines.map((line, index) => {
                        const lineNumber = `<span class="line-number">${index + 1}</span>`;
                        const highlightClass = differences.includes(line.trim())
                            ? (isReference ? 'ref-diff' : 'comp-diff')
                            : '';
                        return `<p class="line">${lineNumber}<span class="${highlightClass}">${line}</span></p>`;
                    }).join("");
                }
                
                
                function formatConfigurationWithPageNumbers(config, differences, isReference) {
                    const lines = config.split("\n");
                    let pageCounter = 1;
                    let formattedConfig = "";
                
                    lines.forEach((line, index) => {
                        // Ak je riadok medzi rozdielmi, pridá sa príslušná trieda
                        const highlightClass = differences.includes(line.trim())
                            ? (isReference ? 'ref-diff' : 'comp-diff')
                            : '';
                
                        // Číslovanie riadkov
                        const lineNumber = `<span class="line-number">${index + 1}</span>`;
                
                        // Pridanie riadku s podfarbením
                        formattedConfig += `
                            <p class="line">
                                ${lineNumber}<span class="${highlightClass}">${line}</span>
                            </p>
                        `;
                    });
                
                    return formattedConfig;
                }

                function downloadReport() {
                    if (window.latestReportFilename) {
                        window.location.href = `/download_report?file=${window.latestReportFilename}`;
                    } else {
                        alert("No report available for download.");
                    }
                }
                
                document.addEventListener("DOMContentLoaded", function () {
                    // 1. Scroll synchronizácia
                    const refResult = document.getElementById("refResult");
                    const compResult = document.getElementById("compResult");

                    function syncScroll(e) {
                        if (e.target === refResult) compResult.scrollTop = refResult.scrollTop;
                        else if (e.target === compResult) refResult.scrollTop = compResult.scrollTop;
                    }

                    refResult.addEventListener("scroll", syncScroll);
                    compResult.addEventListener("scroll", syncScroll);

                    // 2. Setup drag & drop
                    setupFileUpload('ref_files_input', 'add_ref_file_button', 'ref_file_list', refFileList, renderRefList);
                    setupFileUpload('comp_files_input', 'add_comp_file_button', 'comp_file_list', compFileList, renderCompList);

                    // 3. Nastavenia porovnávania (AI módy, modely)
                    const compareModeRadios = document.getElementsByName("compare_mode");
                    const apiKeyInput = document.getElementById("api-key-input");
                    const modelSelectorWrapper = document.getElementById("model-selector-wrapper");
                    const modelSelector = document.getElementById("model-selector");

                
                    compareModeRadios.forEach(radio => radio.addEventListener("change", updateSettingsUI));
                    updateSettingsUI();

                    // 4. Skryť nastavenia mimo kliknutia
                    document.addEventListener("click", function(event) {
                        const menu = document.getElementById("settings-menu");
                        const icon = document.querySelector(".settings-icon");
                        if (!menu.contains(event.target) && !icon.contains(event.target)) {
                            menu.classList.remove("show");
                        }
                    });
                });

                function updateSettingsUI() {
                        const selectedMode = document.querySelector('input[name="compare_mode"]:checked')?.value;
                        const apiKeyInput = document.getElementById("api-key-input");
                        const modelSelectorWrapper = document.getElementById("model-selector-wrapper");
                        const modelSelector = document.getElementById("model-selector");

                        const schoolModels = [
                            "deepseek-r1:32b", "deepseek-r1:14b", "deepseek-r1:8b", "deepseek-r1:7b", "deepseek-r1:1.5b",
                            "llama3.2:3b", "llava:34b", "llava:7b", "mistral:7b", "phi4:14b",
                            "qwen2.5-coder:14b", "qwen2.5-coder:7b", "qwen2.5:7b", "qwq:32b"
                        ];
                
                        const openaiModels = [
                            "gpt-4", "gpt-4-turbo", "gpt-4-32k", "gpt-4-vision-preview",
                            "gpt-3.5-turbo", "gpt-3.5-turbo-16k"
                        ];

                        if (selectedMode === "chatgpt_ai") {
                            apiKeyInput.style.display = "block";
                            modelSelectorWrapper.style.display = "block";
                            populateModelOptions(openaiModels, modelSelector);
                        } else if (selectedMode === "school_ai" || selectedMode === "school_ai_line_by_line") {
                            apiKeyInput.style.display = "none";
                            modelSelectorWrapper.style.display = "block";
                            populateModelOptions(schoolModels, modelSelector);
                        } else {
                            apiKeyInput.style.display = "none";
                            modelSelectorWrapper.style.display = "none";
                        }
                    }
                    // Funkcia na naplnenie možností modelov
                    function populateModelOptions(models, modelSelector) {
                        modelSelector.innerHTML = "";
                        models.forEach(model => {
                            const option = document.createElement("option");
                            option.value = model;
                            option.textContent = model;
                            modelSelector.appendChild(option);
                        });
                    }
                
                function toggleSettingsMenu() {
                    const menu = document.getElementById("settings-menu");
                    menu.classList.toggle("show");
                    if (menu.classList.contains("show")) {
                        updateSettingsUI(); // načíta modely podľa režimu
                    }
                }
            </script>
        </body>
        </html>
